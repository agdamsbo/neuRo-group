# REDCap in R {#redcap}

Working with data analysis in th egroup, and in general it is highly advisable to keep data at a secure server (like [REDCap](redcap.rm.dk)) and only working on temporary data on your machine only saving outcome and aggregated tables if necessary.

In the following is a guide to get started working on REDCap data in R using the [REDCapR-package](https://ouhscbbmc.github.io/REDCapR/).[@R-REDCapR]

Following the package link provides an extensive description on workflows and functionality. However, sometimes less is more, and so goes.

## Getting started

Before you are able to get any data out of REDCap, make sure that you are able to get in. After you are logged in, make sure, that you have permissions to get an API-key. The API-key is a alpha-numeric key used to verify yourself to the REDCap-server, when requesting data export.

```{r readcapr-start, eval=FALSE}
library(REDCapR)
# Returns the variables "record_id" and "age".
ds_some_vars <- redcap_read(
  redcap_uri   = "https://redcap.au.dk/api/",  # This is the address for projects at the AU-server
  token        = "YOUR_API_KEY_GOES_HERE",
  fields       = c("record_id", "age")
)$data 

# Return only records with IDs of 1 and 4
ds_some_rows <- redcap_read(
  redcap_uri   = "https://redcap.au.dk/api/",  # This is the address for projects at the AU-server
  token        = "YOUR_API_KEY_GOES_HERE",
  records      = c(1, 4)
)$data
```

To get a full list of available variable names, you can either go through the codebook on REDCap, or you can try the following, but be aware, that the resulting vector of variable names can get a little long and confusing.

```{r readcapr-colnames, eval=FALSE}
# Returns a vector of names of all accessible variables.
variable_names <- redcap_read(
  redcap_uri   = "https://redcap.au.dk/api/",  # This is the address for projects at the AU-server
  token        = "YOUR_API_KEY_GOES_HERE"
)$data |> 
  colnames()
```

Note that the ' \|\> ' is the pipe-operator native to R since version 4.1. It works similarly to the ' %\>% ' from the [*tidyverse*](https://tidyverse.tidyverse.org).

## Downloading data

When using a longitudinal project design or the "repeated instruments" functionality within REDcap, the dataset will be structured in "long" format with several rows for each ID (one for each "event" and "instance" of repeated instrument). 

Depending on the analysis, the data set can be converted to a "wide" format, with only one row per ID. The `pivot_wider()` from the `tidyr pakckage` can be used, but the most straight-forward approach is to only download the data needed and use the `join_left()` function to merge data. When handling data from repeated instruments the `pivot_wider()` can be used first.

Here is an example on how to export data on RBANS and cleaning the data for plotting.

```{r readcapr-example, eval=FALSE}
ds <- redcap_read(
  redcap_uri   = "https://redcap.au.dk/api/",  # This is the address for projects at the AU-server
  token        = "YOUR_API_KEY_GOES_HERE",
  records      = c(1:35), # Downloading data from ID 1 to 35.
  forms        = "rbans", # Downloading only the RBANS instrument
  event        = c("3_months_arm_1", # Specifying only to download 3 and 12 months data
                   "12_months_arm_1")
  )$data |> 
  select( # Selecting variables to keep
    c("record_id",
      "redcap_event_name",
      ends_with(c("_is","_lo","_up","_per"))) # I only want index scores, lower and upper CIs and percentile.
         )   |> 
  na.omit() # Omitting IDs with missing data.
head(ds, n = 5) # Showing only the first 5 rows
```

Further examples and scripts can be found in the [ENIGMA code repository](https://github.com/agdamsbo/ENIGMAtrial_R).

## Notes

As a standard only export privileges should be given to an API-key and only to de-identified data.

Full access with both read and write access is possible but should be highly restricted.

API-keys should be regenerated regularly.
